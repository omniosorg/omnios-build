diff -wpruN --no-dereference '--exclude=*.orig' a~/misc.c a/misc.c
--- a~/misc.c	1970-01-01 00:00:00
+++ a/misc.c	1970-01-01 00:00:00
@@ -37,6 +37,9 @@
 #include <stdint.h>
 #include <string.h>
 #include <stdbool.h>
+#ifdef __sun
+#include <stdlib.h>		/* fdwalk() declaration */
+#endif
 
 #include "screen.h"
 
@@ -150,6 +153,26 @@ void Kill(pid_t pid, int sig)
 	(void)kill(pid, sig);
 }
 
+#ifdef __sun
+
+static int closeallfiles_cb(void *arg, int fd)
+{
+	const int except = (int)(uintptr_t)arg;
+
+	if (fd >= 3 && fd != except)
+		return (close(fd));
+
+	return (0);
+}
+
+void closeallfiles(int except)
+{
+	if (fdwalk(closeallfiles_cb, (void *)(uintptr_t)except) != 0)
+		Panic(errno, "fdwalk");
+}
+
+#else
+
 void closeallfiles(int except)
 {
 	struct pollfd pfd[1024];
@@ -178,6 +201,8 @@ void closeallfiles(int except)
 	}
 }
 
+#endif /* __sun */
+
 /*
  *  Security - switch to real uid
  */
